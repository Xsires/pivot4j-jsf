<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions">
<h:head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>Pivot4J JSF Sample Application</title>
	<link type="text/css" rel="stylesheet" href="resources/css/style.css" />

	<script type="text/javascript" src="resources/js/mdx.js"></script>
</h:head>

<h:body id="body">
	<f:event type="preRenderView" listener="#{pivotGridHandler.render}" />

	<pe:layout id="workbench" fullPage="true"
		options="#{workbenchHandler.layoutOptions}" widgetVar="workbench">
		<pe:layoutPane id="toolbar-pane" position="north"
			styleClass="toolbar-area">
			<h:form id="toolbar-form">
				<p:toolbar id="toolbar">
					<p:toolbarGroup align="left">
						<p:commandButton type="button" value="About" icon="ui-icon-info"
							onclick="about.show();" />
						<p:separator />
						<h:outputLabel value="Drill : " for="drilldown-mode" />
						<p:selectOneButton id="drilldown-mode" style="display: inline"
							value="#{pivotGridHandler.drillDownMode}"
							disabled="#{!pivotModelManager.model.initialized}">
							<f:selectItem itemLabel="Position" itemValue="position" />
							<f:selectItem itemLabel="Member" itemValue="member" />
							<f:selectItem itemLabel="Replace" itemValue="replace" />
							<p:ajax update=":grid-form" />
						</p:selectOneButton>
						<p:selectBooleanButton value="#{pivotGridHandler.drillThrough}"
							onLabel="Through" offLabel="Through"
							disabled="#{!pivotModelManager.model.initialized or !pivotModelManager.model.cube.drillThroughEnabled}">
							<p:ajax update=":grid-form" />
						</p:selectBooleanButton>
						<p:separator />
						<p:selectBooleanButton
							value="#{pivotGridHandler.showParentMembers}"
							onLabel="Hide Parent" offLabel="Show Parent"
							onIcon="ui-icon-arrowthickstop-1-n"
							offIcon="ui-icon-arrowthickstop-1-n"
							disabled="#{!pivotModelManager.model.initialized}">
							<p:ajax update=":grid-form" />
						</p:selectBooleanButton>
						<p:selectBooleanButton value="#{pivotGridHandler.hideSpans}"
							onLabel="Show Spans" offLabel="Hide Spans"
							onIcon="ui-icon-circlesmall-minus"
							offIcon="ui-icon-circlesmall-minus"
							disabled="#{!pivotModelManager.model.initialized}">
							<p:ajax update=":grid-form" />
						</p:selectBooleanButton>
						<p:selectBooleanButton value="#{pivotGridHandler.nonEmpty}"
							onLabel="Non Empty" offLabel="Non Empty"
							onIcon="ui-icon-circlesmall-close"
							offIcon="ui-icon-circlesmall-close"
							disabled="#{!pivotModelManager.model.initialized}">
							<p:ajax update=":grid-form,:editor-form" />
						</p:selectBooleanButton>
						<p:selectBooleanButton value="#{pivotGridHandler.swapAxes}"
							onLabel="Swap Axes" offLabel="Swap Axes" onIcon="ui-icon-refresh"
							offIcon="ui-icon-refresh"
							disabled="#{!pivotModelManager.model.initialized}">
							<p:ajax update=":grid-form,:editor-form,:target-tree-form" />
						</p:selectBooleanButton>
						<p:separator />
						<p:menuButton value="Export"
							disabled="#{!pivotModelManager.model.initialized}">
							<p:menuitem value="Microsoft Excel(.xls)"
								action="#{pivotExportHandler.exportExcel}" icon="ui-icon-disk"
								ajax="false">
								<f:param name="format" value="HSSF" />
							</p:menuitem>
							<p:menuitem value="Microsoft Excel(.xlsx)"
								action="#{pivotExportHandler.exportExcel}" icon="ui-icon-disk"
								ajax="false">
								<f:param name="format" value="SXSSF" />
							</p:menuitem>
							<p:menuitem value="PDF(.pdf)" icon="ui-icon-print"
								onclick="exportConfig.show();" />
						</p:menuButton>
					</p:toolbarGroup>

					<p:toolbarGroup align="right">
						<p:menuButton value="Links">
							<p:menuitem value="Home"
								url="http://mysticfall.github.com/pivot4j" />
							<p:menuitem value="Project Page"
								url="https://github.com/mysticfall/pivot4j" />
							<p:menuitem value="Discussion Forum"
								url="https://groups.google.com/forum/#!forum/pivot4j-list" />
						</p:menuButton>
					</p:toolbarGroup>
				</p:toolbar>
			</h:form>
		</pe:layoutPane>

		<pe:layoutPane id="navigator-pane" position="west">
			<f:facet name="header">
				<h:panelGroup layout="block">
					<h:panelGroup styleClass="ui-icon ui-icon-title ui-icon-search" />
					<h:outputText value="OLAP Navigator" />
				</h:panelGroup>
			</f:facet>

			<pe:layoutPane id="cube-list-pane" position="north">
				<h:form id="cube-list-form">
					<h:outputLabel value="Cube" for="cube-list" />
					<h:selectOneMenu id="cube-list"
						value="#{pivotModelManager.cubeName}">
						<f:selectItems value="#{dataSourceManager.cubes}" var="cube"
							itemLabel="#{cube.itemLabel}" itemValue="#{cube.itemValue}" />
						<p:ajax event="change"
							listener="#{pivotModelManager.onCubeChange}"
							update=":source-tree-form,:target-tree-form,:grid-form,:editor-form,:toolbar-form" />
					</h:selectOneMenu>
				</h:form>
			</pe:layoutPane>

			<pe:layoutPane id="source-tree-pane" position="center">
				<f:facet name="header">
					<h:outputText value="Cube Structure" />
				</f:facet>

				<h:form id="source-tree-form">
					<p:tree id="cube-navigator" styleClass="navigator"
						value="#{navigatorHandler.cubeNode}" dynamic="true" cache="true"
						var="node" animate="true">
						<p:treeNode type="dimension" icon="ui-icon-dim">
							<h:outputText id="dimension-node" value="#{node.name}"
								styleClass="node-dimension" />
						</p:treeNode>

						<p:treeNode type="hierarchy" icon="ui-icon-hier">
							<h:outputText id="hierarchy-node" value="#{node.name}"
								styleClass="node-hierarchy" />
							<p:draggable for="hierarchy-node"
								helper="clone', appendTo: 'body" revert="true" />
						</p:treeNode>

						<p:treeNode type="level" icon="ui-icon-level#{node.depth}">
							<h:outputText id="level-node" value="#{node.name}"
								styleClass="node-level" />
							<!-- workaround for issue #1 -->
							<p:draggable for="level-node" helper="clone', appendTo: 'body"
								revert="true" />
						</p:treeNode>

						<p:treeNode type="measure" icon="ui-icon-measure">
							<h:outputText id="member-node" value="#{node.name}"
								styleClass="node-member" />
							<!-- workaround for issue #1 -->
							<p:draggable for="member-node" helper="clone', appendTo: 'body"
								revert="true" />
						</p:treeNode>
					</p:tree>
					<p:droppable for="cube-navigator"
						hoverStyleClass="drop-target-node">
						<p:ajax listener="#{navigatorHandler.onDrop}"
							update=":source-tree-form,:target-tree-form,:grid-form,:editor-form" />
					</p:droppable>
				</h:form>
			</pe:layoutPane>
			<pe:layoutPane id="target-tree-pane" position="south">
				<f:facet name="header">
					<h:outputText value="Pivot Structure" />
				</f:facet>

				<h:form id="target-tree-form">
					<p:tree id="target-navigator" styleClass="navigator"
						value="#{navigatorHandler.targetNode}" dynamic="true" cache="true"
						var="node" animate="true">
						<p:treeNode type="columns" icon="ui-icon-cols">
							<h:outputText id="columns-node" value="Columns"
								styleClass="node-axis" />
							<p:droppable for="columns-node"
								hoverStyleClass="drop-target-node">
								<p:ajax listener="#{navigatorHandler.onDropOnAxis}"
									update=":source-tree-form,:target-tree-form,:grid-form,:editor-form" />
							</p:droppable>
						</p:treeNode>

						<p:treeNode type="rows" icon="ui-icon-rows">
							<h:outputText id="rows-node" value="Rows" styleClass="node-axis" />
							<p:droppable for="rows-node" hoverStyleClass="drop-target-node">
								<p:ajax listener="#{navigatorHandler.onDropOnAxis}"
									update=":source-tree-form,:target-tree-form,:grid-form,:editor-form" />
							</p:droppable>
						</p:treeNode>

						<p:treeNode type="filter" icon="ui-icon-filter">
							<h:outputText id="filter-node" value="Filter"
								styleClass="node-axis" />
							<p:droppable for="filter-node" hoverStyleClass="drop-target-node" />
						</p:treeNode>

						<p:treeNode type="hierarchy" icon="ui-icon-hier">
							<h:outputText id="hierarchy-node" value="#{node.caption}"
								styleClass="node-hierarchy" />
							<p:commandButton icon="ui-button-icon-only ui-icon-search"
								action="#{memberSelectionHandler.show}" update=":hierarchy-form"
								oncomplete="hierarchyConfig.show();">
								<f:param name="hierarchy" value="#{node.name}" />
							</p:commandButton>
							<!-- workaround for issue #1 -->
							<p:draggable for="hierarchy-node"
								helper="clone', appendTo: 'body" revert="true" />
							<p:droppable for="hierarchy-node"
								hoverStyleClass="drop-target-node">
								<p:ajax listener="#{navigatorHandler.onDropOnHierarchy}"
									update=":source-tree-form,:target-tree-form,:grid-form,:editor-form" />
							</p:droppable>
						</p:treeNode>

						<p:treeNode type="level" icon="ui-icon-level#{node.depth}">
							<h:outputText id="level-node" value="#{node.caption}"
								styleClass="node-level" />
							<!-- workaround for issue #1 -->
							<p:draggable for="level-node" helper="clone', appendTo: 'body"
								revert="true" />
						</p:treeNode>

						<p:treeNode type="measure" icon="ui-icon-measure">
							<h:outputText id="member-node" value="#{node.caption}"
								styleClass="node-member" />
							<!-- workaround for issue #1 -->
							<p:draggable for="member-node" helper="clone', appendTo: 'body"
								revert="true" />
							<p:droppable for="member-node" hoverStyleClass="drop-target-node">
								<p:ajax listener="#{navigatorHandler.onDropOnMember}"
									update=":source-tree-form,:target-tree-form,:grid-form,:editor-form" />
							</p:droppable>
						</p:treeNode>
					</p:tree>
				</h:form>
			</pe:layoutPane>
		</pe:layoutPane>

		<pe:layoutPane id="content-pane" position="center">
			<f:facet name="header">
				<h:panelGroup layout="block">
					<h:panelGroup styleClass="ui-icon ui-icon-title ui-icon-calculator" />
					<h:outputText value="Query Result" />
				</h:panelGroup>
			</f:facet>

			<pe:layoutPane id="grid-header-pane" position="north">
				<h:panelGrid id="filter-panel" styleClass="filter-panel" columns="2"
					columnClasses="ui-widget-header,filter-items">
					<h:outputText value="Filter" />
					<h:panelGroup layout="block">
						<h:panelGroup id="filter-items" layout="block"
							binding="#{filterHandler.filterPanel}">
						</h:panelGroup>
						<p:droppable for="filter-items"
							hoverStyleClass="filter-items-hover">
							<p:ajax listener="#{filterHandler.onDrop}"
								update=":filter-panel,:filter-form" />
						</p:droppable>

						<p:growl showDetail="true" sticky="true" />
					</h:panelGroup>
				</h:panelGrid>

				<h:panelGroup id="filter-dialog" layout="block">
					<p:overlayPanel widgetVar="filterDialog" hideEffect="fade"
						for=":filter-items" dynamic="true" showEvent="none"
						appendToBody="true" styleClass="ui-dialog filter-dialog"
						onHide="onFilterDialogClose();">
						<h:form id="filter-form">
							<p:tree value="#{filterHandler.filterNode}" dynamic="true"
								cache="true" var="node" selectionMode="checkbox" animate="true"
								propagateSelectionUp="false" propagateSelectionDown="false"
								selection="#{filterHandler.selection}">
								<p:treeNode type="member" icon="ui-icon-member">
									<h:outputText value="#{node.name}" styleClass="node-member" />
								</p:treeNode>

								<p:ajax event="select"
									listener="#{filterHandler.onNodeSelected}"
									update=":filter-form:filter-button-bar" />
								<p:ajax event="unselect"
									listener="#{filterHandler.onNodeUnselected}"
									update=":filter-form:filter-button-bar" />
							</p:tree>

							<p:messages showDetail="true" autoUpdate="true" closable="true" />

							<h:panelGroup id="filter-button-bar" styleClass="button-bar"
								layout="block">
								<p:commandButton value="Ok" icon="ui-icon-check"
									binding="#{filterHandler.buttonApply}"
									action="#{filterHandler.apply}"
									update=":filter-panel,:source-tree-form,:grid-form,:editor-form"
									oncomplete="filterDialog.hide();" />
								<p:button value="Close" icon="ui-icon-close"
									onclick="filterDialog.hide(); return false;" />
							</h:panelGroup>

							<p:remoteCommand name="onFilterDialogClose"
								action="#{filterHandler.onClose}" update=":filter-panel" />
						</h:form>
					</p:overlayPanel>
				</h:panelGroup>
			</pe:layoutPane>

			<pe:layoutPane id="grid-content-pane" position="center">
				<h:form id="grid-form">
					<p:panelGrid id="pivot-grid" styleClass="pivot-grid"
						binding="#{pivotGridHandler.pivotGrid}"
						rendered="#{pivotGridHandler.valid}" />

					<h:panelGroup styleClass="info-panel" layout="block"
						rendered="#{!pivotGridHandler.valid}">
						<h:panelGroup styleClass="ui-icon ui-icon-title ui-icon-info" />
						<h:outputText
							value="You need to put at least one level or measure on Columns and Rows for a valid query."
							styleClass="message-warn" />
					</h:panelGroup>
				</h:form>
			</pe:layoutPane>

			<pe:layoutPane id="mdx-editor-pane" position="south">
				<f:facet name="header">
					<h:panelGroup layout="block">
						<h:panelGroup styleClass="ui-icon ui-icon-title ui-icon-script" />
						<h:outputText value="MDX Query" />
					</h:panelGroup>
				</f:facet>

				<h:form id="editor-form">
					<p:toolbar id="editor-toolbar">
						<p:toolbarGroup align="left">
							<p:commandButton value="Run" icon="ui-icon-play"
								action="#{pivotGridHandler.executeMdx}"
								update=":cube-list-form,:source-tree-form,:target-tree-form,:grid-form,:editor-form,:filter-panel,:toolbar-form" />
							<p:commandButton value="Reset"
								icon="ui-icon-arrowreturnthick-1-w" update="mdx-editor" />
						</p:toolbarGroup>
						<p:toolbarGroup align="right" styleClass="query-info"
							rendered="#{!empty pivotGridHandler.duration}">
							<h:panelGroup styleClass="ui-icon ui-icon-title ui-icon-clock" />
							<h:outputText value="Query execution time : " />
							<h:outputText value="#{pivotGridHandler.duration}">
								<f:convertNumber pattern="###,### msec" />
							</h:outputText>
						</p:toolbarGroup>
					</p:toolbar>
					<pe:codeMirror id="mdx-editor" mode="text/x-mdx"
						value="#{pivotGridHandler.currentMdx}" lineNumbers="true"
						lineWrapping="true" matchBrackets="true" theme="eclipse"
						widgetVar="mdxEditor" required="true" />

					<p:growl id="editor-growl" showDetail="true" sticky="true" />
				</h:form>
			</pe:layoutPane>
		</pe:layoutPane>

		<p:ajax event="open" update="editor-form:mdx-editor" />
	</pe:layout>

	<ui:include src="about.xhtml" />
	<ui:include src="hierarchy-config.xhtml" />
	<ui:include src="export-config.xhtml" />
	<ui:include src="drillthrough.xhtml" />

	<p:ajaxStatus styleClass="ajax-status">
		<f:facet name="start">
			<p:graphicImage value="/resources/images/loading.gif" />
		</f:facet>

		<f:facet name="complete">
			<h:outputText value="" />
		</f:facet>
	</p:ajaxStatus>

	<p:growl id="growl" showDetail="true" sticky="true" />
</h:body>
</html>
